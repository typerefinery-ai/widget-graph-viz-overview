<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Communication Workbench - Force-Directed Graph</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #00ff00;
            height: 100vh;
            overflow: hidden;
        }

        .workbench {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 400px;
            background-color: #2d2d2d;
            border-right: 2px solid #00ff00;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .iframe-container {
            flex: 1;
            background-color: #000;
            border: 2px solid #00ff00;
            margin: 20px;
            position: relative;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }

        .console {
            height: 300px;
            background-color: #000;
            border: 2px solid #00ff00;
            margin: 0 20px 20px 20px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .console-line {
            margin-bottom: 5px;
            word-wrap: break-word;
        }

        .console-line.incoming {
            color: #00ffff;
        }

        .console-line.outgoing {
            color: #ffff00;
        }

        .console-line.error {
            color: #ff0000;
        }

        .console-line.info {
            color: #00ff00;
        }

        .console-line.timestamp {
            color: #888;
            font-size: 10px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #00ff00;
            margin-bottom: 15px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            background-color: #2d2d2d;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #00ff00;
            color: #000;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn.danger {
            border-color: #ff0000;
            color: #ff0000;
        }

        .btn.danger:hover {
            background-color: #ff0000;
            color: #000;
        }

        .btn.success {
            border-color: #00ff00;
            color: #00ff00;
        }

        .btn.success:hover {
            background-color: #00ff00;
            color: #000;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #00ff00;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            background-color: #1e1e1e;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .input-group textarea {
            height: 80px;
            resize: vertical;
        }

        .status {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #2d2d2d;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-size: 11px;
        }

        .clear-btn {
            position: absolute;
            top: 10px;
            right: 100px;
            background-color: #2d2d2d;
            border: 1px solid #ff0000;
            color: #ff0000;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
        }

        .clear-btn:hover {
            background-color: #ff0000;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="workbench">
        <div class="sidebar">
            <div class="section">
                <h3>üì° Communication</h3>
                <div class="button-group">
                    <button class="btn success" onclick="requestOverviewData()">üìä Load Data</button>
                    <button class="btn" onclick="sendDataRefresh()">üîÑ Send Data Refresh</button>
                    <button class="btn danger" onclick="sendClearData()">üóëÔ∏è Clear Data</button>
                    <button class="btn" onclick="sendCustomMessage()">üí¨ Send Custom Message</button>
                    <button class="btn" onclick="simulateError()">‚ùå Simulate Error</button>
                    <button class="btn" onclick="simulateTimeout()">‚è∞ Simulate Timeout</button>
                </div>
            </div>

            <div class="section">
                <h3>üîß Actions</h3>
                <div class="button-group">
                    <button class="btn" onclick="reloadWidget()">üîÑ Reload Widget</button>
                    <button class="btn" onclick="clearConsole()">üßπ Clear Console</button>
                    <button class="btn danger" onclick="simulateCrash()">üí• Simulate Crash</button>
                </div>
            </div>

            <div class="section">
                <h3>üìù Custom Message</h3>
                <div class="input-group">
                    <label for="messageType">Message Type:</label>
                    <input type="text" id="messageType" value="embed-viz-event-payload-data-overview-default-incident" placeholder="Enter message type">
                </div>
                <div class="input-group">
                    <label for="messageData">Message Data (JSON):</label>
                    <textarea id="messageData" placeholder='{"action": "DATA_REFRESH", "payload": {}}'>{"action": "DATA_REFRESH", "payload": {}}</textarea>
                </div>
                <button class="btn success" onclick="sendCustomMessage()">üì§ Send</button>
            </div>

            <div class="section">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="input-group">
                    <label for="iframeUrl">Iframe URL:</label>
                    <input type="text" id="iframeUrl" value="http://localhost:4008/" placeholder="Enter iframe URL">
                </div>
                <button class="btn" onclick="reloadIframe()">üîÑ Reload Iframe</button>
            </div>

            <div class="section">
                <h3>üìã Event Info</h3>
                <div class="input-group">
                    <label>Event Name:</label>
                    <input type="text" value="embed-viz-event-payload-data-overview-default-incident" readonly style="background-color: #1a1a1a;">
                </div>
                <div class="input-group">
                    <label>Data Endpoint:</label>
                    <input type="text" value="/viz-data/overview-default-incident" readonly style="background-color: #1a1a1a;">
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="iframe-container">
                <div class="status" id="status">üü¢ Connected</div>
                <button class="clear-btn" onclick="clearConsole()">Clear</button>
                <iframe id="widgetFrame" src=""></iframe>
            </div>
            <div class="console" id="console">
                <div class="console-line info">üöÄ Widget Communication Workbench Started</div>
                <div class="console-line info">üì° Listening for iframe messages...</div>
                <div class="console-line info">üìä Force-Directed Graph Visualization</div>
                <div class="console-line timestamp">Ready to test widget communication</div>
            </div>
        </div>
    </div>

    <script>
        const consoleElement = document.getElementById('console');
        const iframe = document.getElementById('widgetFrame');
        const statusElement = document.getElementById('status');

        // Message counter for tracking
        let messageCounter = 0;

        // Event name and endpoint for the force-directed graph
        const EVENT_NAME = 'embed-viz-event-payload-data-overview-default-incident';
        const DATA_ENDPOINT = '/viz-data/overview-default-incident';

        // Initialize workbench
        function initWorkbench() {
            log('info', 'Workbench initialized');
            
            // Set the iframe URL to load the widget (using port 4008)
            const defaultUrl = 'http://localhost:4008/';
            iframe.src = defaultUrl;
            document.getElementById('iframeUrl').value = defaultUrl;
            
            log('info', 'Iframe loading: ' + iframe.src);
            
            // Listen for messages from iframe
            window.addEventListener('message', handleIncomingMessage);
            
            // Listen for iframe load events
            iframe.addEventListener('load', () => {
                log('info', 'Iframe loaded successfully');
                updateStatus('üü¢ Connected');
            });

            iframe.addEventListener('error', () => {
                log('error', 'Iframe failed to load');
                updateStatus('üî¥ Error');
            });
        }

        // Handle incoming messages from iframe
        function handleIncomingMessage(event) {
            messageCounter++;
            const timestamp = new Date().toLocaleTimeString();
            
            log('incoming', `[${timestamp}] Message #${messageCounter} received from iframe:`);
            log('incoming', `Origin: ${event.origin}`);
            log('incoming', `Data: ${JSON.stringify(event.data, null, 2)}`);
            
            // Handle widget DATA_REQUEST events
            let eventData = event.data;
            if (typeof eventData === 'string') {
                try {
                    eventData = JSON.parse(eventData);
                } catch (e) {
                    log('error', 'Failed to parse message as JSON');
                    return;
                }
            }
            
            if (eventData && eventData.action === 'DATA_REQUEST') {
                log('info', `Widget requesting data for type: ${eventData.type}`);
                
                // Check if it's the overview-default-incident event
                if (eventData.type === EVENT_NAME || eventData.type.includes('overview-default-incident')) {
                    log('info', 'Loading overview-default-incident fixture data');
                    
                    // Load the fixture data and respond
                    loadOverviewFixtureData().then(fixtureData => {
                        const response = {
                            ...eventData,
                            target: 'iframe-embed_BD8EU3LCD',
                            topicName: EVENT_NAME,
                            eventName: 'readaction',
                            endpointConfig: {
                                method: 'GET',
                                url: `http://localhost:8111${DATA_ENDPOINT}`
                            },
                            url: `http://localhost:8111${DATA_ENDPOINT}`,
                            method: 'GET',
                            payloadType: 'application/json',
                            body: null,
                            ok: true,
                            data: fixtureData
                        };
                        
                        // Send response back to widget
                        setTimeout(() => {
                            sendMessageToIframe(response);
                            log('info', 'Sent overview-default-incident fixture data to widget');
                        }, 100);
                    }).catch(error => {
                        log('error', `Failed to load overview-default-incident fixture data: ${error.message}`);
                        
                        // Send error response
                        const errorResponse = {
                            ...eventData,
                            target: 'iframe-embed_BD8EU3LCD',
                            topicName: EVENT_NAME,
                            eventName: 'readaction',
                            endpointConfig: {
                                method: 'GET',
                                url: `http://localhost:8111${DATA_ENDPOINT}`
                            },
                            url: `http://localhost:8111${DATA_ENDPOINT}`,
                            method: 'GET',
                            payloadType: 'application/json',
                            body: null,
                            ok: false,
                            error: `Failed to load overview-default-incident data: ${error.message}`
                        };
                        
                        setTimeout(() => {
                            sendMessageToIframe(errorResponse);
                        }, 100);
                    });
                } else {
                    log('error', `Unknown event type: ${eventData.type}`);
                }
            }
            
            // Update status
            updateStatus('üü° Message Received');
            
            // Auto-reset status after 2 seconds
            setTimeout(() => {
                updateStatus('üü¢ Connected');
            }, 2000);
        }

        // Send message to iframe
        function sendMessageToIframe(message) {
            messageCounter++;
            const timestamp = new Date().toLocaleTimeString();
            
            log('outgoing', `[${timestamp}] Message #${messageCounter} sent to iframe:`);
            log('outgoing', `Data: ${JSON.stringify(message, null, 2)}`);
            
            iframe.contentWindow.postMessage(message, '*');
            
            // Update status
            updateStatus('üü° Message Sent');
            
            // Auto-reset status after 2 seconds
            setTimeout(() => {
                updateStatus('üü¢ Connected');
            }, 2000);
        }

        // Logging function
        function log(type, message) {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = message;
            consoleElement.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        // Update status indicator
        function updateStatus(status) {
            statusElement.textContent = status;
        }

        // Clear console
        function clearConsole() {
            consoleElement.innerHTML = '';
            log('info', 'Console cleared');
        }

        // Reload iframe
        function reloadIframe() {
            const url = document.getElementById('iframeUrl').value;
            iframe.src = url;
            log('info', `Reloading iframe with URL: ${url}`);
        }

        // Load overview-default-incident fixture data
        async function loadOverviewFixtureData() {
            try {
                // Load from cypress fixtures path (served by webpack dev server)
                const response = await fetch('/cypress/fixtures/src/assets/data/overview-default-incident.json');
                if (!response.ok) {
                    throw new Error(`Failed to load fixture: ${response.status}`);
                }
                
                const fixtureData = await response.json();
                log('info', 'Loaded overview-default-incident fixture data successfully');
                log('info', `Data contains ${fixtureData.nodes?.length || 0} nodes and ${fixtureData.edges?.length || 0} edges`);
                return fixtureData;
            } catch (error) {
                log('error', `Error loading overview-default-incident fixture data: ${error.message}`);
                throw error;
            }
        }

        // Request overview data
        function requestOverviewData() {
            loadOverviewFixtureData().then(data => {
                const message = {
                    type: EVENT_NAME,
                    action: 'DATA_REFRESH',
                    payload: {
                        action: 'load_data',
                        id: 'overview-default-incident',
                        type: 'load',
                        endpoint: DATA_ENDPOINT
                    },
                    componentId: `overview-default-incident-${EVENT_NAME}-load_data`,
                    data: data
                };
                sendMessageToIframe(message);
                log('info', 'Sent overview data to widget');
            }).catch(error => {
                log('error', `Failed to load overview data: ${error.message}`);
            });
        }

        // Send data refresh event
        function sendDataRefresh() {
            const message = {
                type: EVENT_NAME,
                action: 'DATA_REFRESH',
                payload: {
                    action: 'load_data',
                    id: 'overview-default-incident',
                    type: 'load',
                    endpoint: DATA_ENDPOINT
                },
                componentId: `overview-default-incident-${EVENT_NAME}-load_data`
            };
            sendMessageToIframe(message);
            log('info', 'Sent DATA_REFRESH event to widget');
        }

        // Send clear data event
        function sendClearData() {
            const message = {
                type: EVENT_NAME,
                action: 'CLEAR_DATA',
                payload: {
                    action: 'clear_data',
                    id: 'overview-default-incident'
                },
                componentId: `overview-default-incident-${EVENT_NAME}-clear_data`
            };
            sendMessageToIframe(message);
            log('info', 'Sent CLEAR_DATA event to widget');
        }

        function sendCustomMessage() {
            const type = document.getElementById('messageType').value;
            const dataText = document.getElementById('messageData').value;
            
            let data;
            try {
                data = JSON.parse(dataText);
            } catch (e) {
                log('error', 'Invalid JSON in message data');
                return;
            }
            
            const message = {
                type: type,
                ...data,
                timestamp: new Date().toISOString()
            };
            sendMessageToIframe(message);
        }

        // Simulate Error event
        function simulateError() {
            const errorMessage = {
                type: EVENT_NAME,
                action: "ERROR",
                payload: { message: "Simulated error from workbench" },
                target: "widget"
            };
            sendMessageToIframe(errorMessage);
            log('outgoing', 'Simulated error message sent to widget');
        }

        // Simulate Timeout event
        function simulateTimeout() {
            const timeoutMessage = {
                type: EVENT_NAME,
                action: "TIMEOUT",
                payload: { message: "Simulated timeout from workbench" },
                target: "widget"
            };
            sendMessageToIframe(timeoutMessage);
            log('outgoing', 'Simulated timeout message sent to widget');
        }

        // Simulate Crash event
        function simulateCrash() {
            const crashMessage = {
                type: EVENT_NAME,
                action: "CRASH",
                payload: { message: "Simulated crash from workbench" },
                target: "widget"
            };
            sendMessageToIframe(crashMessage);
            log('outgoing', 'Simulated crash message sent to widget');
        }

        // Reload Widget event
        function reloadWidget() {
            log('info', 'Reloading widget iframe...');
            // Reload the iframe - widget will automatically request data on init
            const url = document.getElementById('iframeUrl').value;
            iframe.src = '';
            
            // Wait a moment before setting new src to ensure clean reload
            setTimeout(() => {
                iframe.src = url;
                log('info', `Widget iframe reloaded with URL: ${url}`);
                log('info', 'Widget will automatically request data on initialization');
                
                // The widget will send DATA_REQUEST on init, and our message listener will respond
                // No need to manually send data - just ensure we're ready to respond
            }, 100);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'l':
                        e.preventDefault();
                        clearConsole();
                        break;
                    case 'r':
                        e.preventDefault();
                        reloadIframe();
                        break;
                    case '1':
                        e.preventDefault();
                        requestOverviewData();
                        break;
                    case '2':
                        e.preventDefault();
                        sendDataRefresh();
                        break;
                }
            }
        });

        // Initialize when page loads
        window.addEventListener('load', initWorkbench);
    </script>
</body>
</html>
